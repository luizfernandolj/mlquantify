
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="1.1. Adjust Counting" />
<meta property="og:type" content="website" />
<meta property="og:url" content="modules/adjust_counting.html" />
<meta property="og:site_name" content="mlquantify" />
<meta property="og:description" content="Adjusted Counting methods improve upon simple “counting” quantifiers by correcting bias using what is known about the classifier’s errors on the training set. They aim to produce better estimates o..." />
<meta property="og:image:width" content="1146" />
<meta property="og:image:height" content="600" />
<meta property="og:image" content="_images/social_previews/summary_modules_adjust_counting_da865eb2.png" />
<meta property="og:image:alt" content="Adjusted Counting methods improve upon simple “counting” quantifiers by correcting bias using what is known about the classifier’s errors on the training set. They aim to produce better estimates o..." />
<meta name="description" content="Adjusted Counting methods improve upon simple “counting” quantifiers by correcting bias using what is known about the classifier’s errors on the training set. They aim to produce better estimates o..." />
<meta name="twitter:card" content="summary_large_image" />

    <title>1.1. Adjust Counting &#8212; mlquantify 0.1.8 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=94d3f708" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=22607128"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'modules/adjust_counting';</script>
    <link rel="canonical" href="https://luizfernandolj.github.io/mlquantify/modules/adjust_counting.html" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="1.2. Likelihood-Based Quantification" href="likelihood.html" />
    <link rel="prev" title="1. Aggregative Quantification" href="../aggregative_quantification.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">mlquantify 0.1.8 documentation</p>
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../install.html">
    Install
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../user_guide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    API
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/luizfernandolj/mlquantify/tree/master" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../install.html">
    Install
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../user_guide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    API
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/luizfernandolj/mlquantify/tree/master" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../aggregative_quantification.html">1.  Aggregative Quantification</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">1.1. Adjust Counting</a></li>
<li class="toctree-l2"><a class="reference internal" href="likelihood.html">1.2. Likelihood-Based Quantification</a></li>
<li class="toctree-l2"><a class="reference internal" href="mixture_models.html">1.3. Mixture Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="neighbors.html">1.4. Neighbors-Based Quantification</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../building_a_quantifier.html">2.  Building a Quantifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_selection_evaluation.html">3.  Model Selection and Evaluation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../experiment_management.html">4.  Experiment Management</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../building_a_protocol.html">4.1. Building a Protocol</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../user_guide.html" class="nav-link">User Guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="../aggregative_quantification.html" class="nav-link"><span class="section-number">1. </span>Aggregative Quantification</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis"><span class="section-number">1.1. </span>Adjust Counting</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="adjust-counting">
<span id="id1"></span><h1><span class="section-number">1.1. </span>Adjust Counting<a class="headerlink" href="#adjust-counting" title="Link to this heading">#</a></h1>
<p>Adjusted Counting methods improve upon simple “counting” quantifiers by correcting bias using what is known about the classifier’s errors on the training set.
They aim to produce better estimates of class prevalence (how frequent each class is in a dataset) even when training and test distributions differ.</p>
<p>Currently, there are two types of adjustment methods implemented:</p>
<ol class="arabic simple">
<li><p><strong>Threshold Adjustment Methods</strong>: These methods adjust the decision threshold of the classifier to optimize prevalence estimation. Examples include Adjusted Classify and Count (ACC) and its probabilistic counterpart PACC.</p></li>
<li><p><strong>Matrix Adjustment Methods</strong>: These methods use a confusion matrix derived from the classifier’s performance on a validation set to adjust the estimated prevalences. Examples include the EM-based methods and other matrix inversion techniques.</p></li>
</ol>
<p>[Plot Idea: Comparison between raw CC estimate vs adjusted estimate when dataset shift occurs]</p>
<section id="classify-and-count">
<h2><span class="section-number">1.1.1. </span>Classify and Count<a class="headerlink" href="#classify-and-count" title="Link to this heading">#</a></h2>
<p>The <strong>Classify and Count (CC)</strong> method is the simplest baseline.
It trains a hard classifier <span class="math notranslate nohighlight">\(h\)</span> on labeled data <span class="math notranslate nohighlight">\(L\)</span> , applies it to an unlabeled set <span class="math notranslate nohighlight">\(U\)</span> , and counts how many samples belong to each predicted class.</p>
<p><strong>Equation</strong></p>
<div class="math notranslate nohighlight">
\[\hat{p}^U_{CC}(y) = \frac{|\{x \in U \mid h(x) = y\}|}{|U|}\]</div>
<dl class="field-list simple">
<dt class="field-odd">caption<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>Estimated prevalence from hard classifier labels</em></p>
</dd>
</dl>
<p><strong>Example</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mlquantify.adjust_counting</span><span class="w"> </span><span class="kn">import</span> <span class="n">CC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">CC</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">q</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">q</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="c1"># -&gt; {0: 0.47, 1: 0.53}</span>
</pre></div>
</div>
<p>CC is fast and simple, but when class proportions in the test set differ from the training set, its estimates can become biased or inaccurate.</p>
</section>
<section id="probabilistic-classify-and-count">
<h2><span class="section-number">1.1.2. </span>Probabilistic Classify and Count<a class="headerlink" href="#probabilistic-classify-and-count" title="Link to this heading">#</a></h2>
<p>The <strong>Probabilistic Classify and Count (PCC)</strong> variant uses the <em>predicted probabilities</em> from a soft classifier instead of hard labels.
This makes it less sensitive to uncertain predictions.</p>
<p><strong>Equation</strong></p>
<div class="math notranslate nohighlight">
\[\hat{p}^U_{PCC}(y) = \frac{1}{|U|} \sum_{x \in U} p(y|x)\]</div>
<dl class="field-list simple">
<dt class="field-odd">caption<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>Estimated prevalence from averaged posterior probabilities</em></p>
</dd>
</dl>
<p>[Plot Idea: A plot comparing probabilities per sample and their averaged mean per class]</p>
<p><strong>Example</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mlquantify.adjust_counting</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">PCC</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">q</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">q</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="c1"># -&gt; {0: 0.45, 1: 0.55}</span>
</pre></div>
</div>
<p>CC and PCC both often underestimate or overestimate the true prevalence when there is distribution shift (also known as “dataset shift”).</p>
</section>
<section id="threshold-adjustment">
<h2><span class="section-number">1.1.3. </span>Threshold Adjustment<a class="headerlink" href="#threshold-adjustment" title="Link to this heading">#</a></h2>
<p>Threshold-based adjustment methods correct the bias of CC by using the classifier’s <strong>True Positive Rate (TPR)</strong> and <strong>False Positive Rate (FPR)</strong>.
They are mainly used for`binary`quantification tasks.</p>
<p><strong>Adjusted Classify and Count (ACC) Equation</strong></p>
<div class="math notranslate nohighlight">
\[\hat{p}^U_{ACC}(⊕) = \frac{\hat{p}^U_{CC}(⊕) - FPR_L}{TPR_L - FPR_L}\]</div>
<dl class="field-list simple">
<dt class="field-odd">caption<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>Corrected prevalence estimate using classifier error rates</em></p>
</dd>
</dl>
<p>The main idea is that by adjusting the observed rate of positive predictions, we can better approximate the real class distribution.</p>
<p>[Plot Idea: Diagram showing how TPR and FPR move the prevalence estimate]</p>
<p>Different <em>threshold methods</em> vary in how they choose the classifier cutoff <span class="math notranslate nohighlight">\(\tau\)</span> for scores <span class="math notranslate nohighlight">\(s(x)\)</span> .</p>
<div class="pst-scrollable-table-container"><table class="table">
<tbody>
<tr class="row-odd"><td><p><strong>Method</strong></p></td>
<td><p><strong>Threshold Choice</strong></p></td>
<td><p><strong>Goal</strong></p></td>
</tr>
<tr class="row-even"><td><p>AC</p></td>
<td><p>Fixed threshold <span class="math notranslate nohighlight">\(\tau = 0.5\)</span></p></td>
<td><p>Simple baseline adjustment</p></td>
</tr>
<tr class="row-odd"><td><p>X</p></td>
<td><p>Threshold where <span class="math notranslate nohighlight">\(\text{FPR} = 1 - \text{TPR}\)</span></p></td>
<td><p>Avoids unstable prediction tails</p></td>
</tr>
<tr class="row-even"><td><p>MAX</p></td>
<td><p>Threshold maximizing <span class="math notranslate nohighlight">\(\text{TPR} - \text{FPR}\)</span></p></td>
<td><p>Improves numerical stability</p></td>
</tr>
<tr class="row-odd"><td><p>T50</p></td>
<td><p>Threshold where <span class="math notranslate nohighlight">\(\text{TPR} = 0.5\)</span></p></td>
<td><p>Uses central part of ROC curve</p></td>
</tr>
<tr class="row-even"><td><p>MS (Median Sweep)</p></td>
<td><p>Median of all thresholds’ ACC results</p></td>
<td><p>Reduces effect of threshold outliers</p></td>
</tr>
<tr class="row-odd"><td><p>MS2</p></td>
<td><p>Median Sweep variant with constraint
<span class="math notranslate nohighlight">\(\|\text{TPR} - \text{FPR}\| &gt; 0.25\)</span></p></td>
<td><p>Reduces effect of threshold outliers</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Example</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mlquantify.adjust_counting</span><span class="w"> </span><span class="kn">import</span> <span class="n">ACC</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">ACC</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">q</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">q</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="c1"># -&gt; adjusted prevalence dictionary</span>
</pre></div>
</div>
<p>[Plot Idea: Show ROC curve with marked chosen thresholds (TPR, FPR, tau)]</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Threshold adjustment methods like ACC are primarily designed for binary classification tasks,
For multi-class problems, matrix adjustment methods are generally preferred.</p>
</div>
</section>
<section id="matrix-adjustment">
<h2><span class="section-number">1.1.4. </span>Matrix Adjustment<a class="headerlink" href="#matrix-adjustment" title="Link to this heading">#</a></h2>
<p>Matrix-based adjustment methods use a <em>confusion matrix</em> or <em>generalized rate matrix</em> to adjust predictions for multi-class quantification.
They treat quantification as solving a small linear system.</p>
<p><strong>Matrix Equation</strong></p>
<div class="math notranslate nohighlight">
\[\mathbf{y = X \hat{\pi}_F + \epsilon}, \quad
\text{subject to } \hat{\pi}_F \ge 0,\ \sum \hat{\pi}_F = 1\]</div>
<dl class="field-list simple">
<dt class="field-odd">caption<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>General linear system linking observed and true prevalences</em></p>
</dd>
</dl>
<p>Here:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\mathbf{y}\)</span>: average observed predictions in <span class="math notranslate nohighlight">\(U\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{X}\)</span>: classifier behavior from training (mean conditional rates)</p></li>
<li><p><span class="math notranslate nohighlight">\(\hat{\pi}_F\)</span>: corrected class prevalences in <span class="math notranslate nohighlight">\(U\)</span></p></li>
</ul>
<p>[Plot Idea: Matrix illustration showing how confusion corrections map to estimated prevalences]</p>
<section id="gac-and-gpac-acc-and-pacc-multiclass">
<h3><span class="section-number">1.1.4.1. </span>GAC and GPAC (ACC and PACC Multiclass)<a class="headerlink" href="#gac-and-gpac-acc-and-pacc-multiclass" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mlquantify.adjust_counting</span><span class="w"> </span><span class="kn">import</span> <span class="n">GAC</span><span class="p">,</span> <span class="n">GPAC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">GAC</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">q</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">q</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="c1"># -&gt; {0: 0.48, 1: 0.52}</span>
</pre></div>
</div>
<p>Both <strong>ACC multiclass (GAC)</strong> and <strong>PACC multiclass (GPAC)</strong> are solved using this linear system:</p>
<ul class="simple">
<li><p>GAC uses hard classifier decisions (confusion matrix).</p></li>
<li><p>GPAC uses soft probabilities <span class="math notranslate nohighlight">\(P(y=l|x)\)</span> .</p></li>
</ul>
</section>
<section id="friedman-s-method-fm">
<h3><span class="section-number">1.1.4.2. </span>Friedman’s Method (FM)<a class="headerlink" href="#friedman-s-method-fm" title="Link to this heading">#</a></h3>
<p>To improve stability, <strong>Friedman’s Method (FM)</strong> generates the adjustment matrix <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> using a special transformation function applied to each class <span class="math notranslate nohighlight">\(l\)</span> and training sample <span class="math notranslate nohighlight">\(x\)</span> :</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">Mathematical details - Friedman’s Method</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<div class="math notranslate nohighlight">
\[f_l(x) = I \left[ \hat{P}_T(y = l \mid x) &gt; \pi_l^T \right]\]</div>
<p class="sd-card-text">where:</p>
<ul class="simple">
<li><p class="sd-card-text"><span class="math notranslate nohighlight">\(I[\cdot]\)</span> is the indicator function, equal to 1 if the condition inside is true, 0 otherwise.</p></li>
<li><p class="sd-card-text"><span class="math notranslate nohighlight">\(\hat{P}_T(y = l \mid x)\)</span> is the classifier’s estimated posterior probability for class <span class="math notranslate nohighlight">\(l\)</span> on training sample <span class="math notranslate nohighlight">\(x\)</span>.</p></li>
<li><p class="sd-card-text"><span class="math notranslate nohighlight">\(\pi_l^T\)</span> is the prevalence of class <span class="math notranslate nohighlight">\(l\)</span> in the training set.</p></li>
</ul>
<p class="sd-card-text">The entry <span class="math notranslate nohighlight">\(X_{i,l}\)</span> of the matrix <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> is computed as the average of <span class="math notranslate nohighlight">\(f_l(x)\)</span> over all <span class="math notranslate nohighlight">\(x\)</span> in class <span class="math notranslate nohighlight">\(i\)</span> of the training data:</p>
<div class="math notranslate nohighlight">
\[X_{i,l} = \frac{1}{|L_i|} \sum_{x \in L_i} f_l(x)\]</div>
<p class="sd-card-text">where:</p>
<ul class="simple">
<li><p class="sd-card-text"><span class="math notranslate nohighlight">\(L_i\)</span> is the subset of training samples with true class <span class="math notranslate nohighlight">\(i\)</span>.</p></li>
<li><p class="sd-card-text"><span class="math notranslate nohighlight">\(|L_i|\)</span> is the number of these samples.</p></li>
</ul>
<p class="sd-card-text">This matrix is then used in the constrained least squares optimization:</p>
<div class="math notranslate nohighlight">
\[\min_{\hat{\pi}_F} \frac{1}{2} \hat{\pi}_F^\top D \hat{\pi}_F + d^\top \hat{\pi}_F
\quad \text{subject to} \quad \hat{\pi}_F \ge 0, \quad \sum \hat{\pi}_F = 1\]</div>
<p class="sd-card-text">to estimate the corrected prevalences <span class="math notranslate nohighlight">\(\hat{\pi}_F\)</span> on the test set.</p>
<p class="sd-card-text">This thresholding on posterior probabilities ensures that the matrix <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> highlights regions where the classifier consistently predicts a class more confidently than its baseline prevalence, improving statistical stability and reducing estimation variance.</p>
</div>
</details><div class="pst-scrollable-table-container"><table class="table">
<tbody>
<tr class="row-odd"><td><p><strong>Method</strong></p></td>
<td><p><strong>Matrix / Function :math:`f_l(x)`</strong></p></td>
<td><p><strong>Resolution</strong></p></td>
</tr>
<tr class="row-even"><td><p>ACC (GAC)</p></td>
<td><p>Indicator of classifier’s hard decision</p></td>
<td><p>Direct linear system</p></td>
</tr>
<tr class="row-odd"><td><p>PACC (GPAC)</p></td>
<td><p>Posterior probability <span class="math notranslate nohighlight">\(P(y=l|x)\)</span></p></td>
<td><p>Direct linear system</p></td>
</tr>
<tr class="row-even"><td><p>FM (Friedman)</p></td>
<td><p>Indicator if <span class="math notranslate nohighlight">\(\hat{P}_T(y=l|x) &gt; \pi_l^T\)</span></p></td>
<td><p>Constrained least-squares (Quadratic Prog.)</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  <div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item">
<div class="prev-next-area">
    <a class="left-prev"
       href="../aggregative_quantification.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">1. </span>Aggregative Quantification</p>
      </div>
    </a>
    <a class="right-next"
       href="likelihood.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">1.2. </span>Likelihood-Based Quantification</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>
                </footer>
              
              
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#classify-and-count">1.1.1. Classify and Count</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#probabilistic-classify-and-count">1.1.2. Probabilistic Classify and Count</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#threshold-adjustment">1.1.3. Threshold Adjustment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#matrix-adjustment">1.1.4. Matrix Adjustment</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gac-and-gpac-acc-and-pacc-multiclass">1.1.4.1. GAC and GPAC (ACC and PACC Multiclass)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#friedman-s-method-fm">1.1.4.2. Friedman’s Method (FM)</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/modules/adjust_counting.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>